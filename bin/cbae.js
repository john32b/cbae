#! /usr/bin/env node
(()=>{var e={382:(e,t,r)=>{const i=r(17);const n=r(147);const s=r(139);const o=r(407);const a=["BINARY","WAVE"];const l={AUDIO:2352,CDG:2448,MODE1_RAW:2352,"MODE1/2048":2048,"MODE1/2352":2352,MODE2_RAW:2352,"MODE2/2048":2048,"MODE2/2324":2324,"MODE2/2336":2336,"MODE2/2352":2352,"CDI/2336":2336,"CDI/2352":2352};class cdinfos{CD_TITLE;CD_SIZE=0;FILE_LOADED=null;FILE_DIR=null;tracks=[];opentrack=null;openfile=null;constructor(e){if(e)this.loadCue(e)}getTrackFilePath(e){return i.join(this.FILE_DIR,this.tracks[e].file??this.tracks[e].shared)}getAudioSize(){return this.tracks.reduce(((e,t)=>e+(t.isData?0:t.byteSize)),0)}generateCueForEncoded(e,t){let r=[];for(let i of this.tracks){let n=`${i.no}`.padStart(2,"0");let s=e+n;if(i.isData){r.push(`\tFILE "${s}.bin" BINARY`)}else{let e=t.slice(1).toUpperCase();r.push(`\tFILE "${s+t}" ${e}`)}r.push(`\t\tTRACK ${n} ${i.type}`);if(i.pregap)r.push(`\t\tPREGAP ${i.pregap}`);let o=i.indexes[0].toFrames();for(let e of i.indexes){let t=new cuetime(e.no,0,0,0);t.fromFrames(e.toFrames()-o);r.push(`\t\tINDEX ${t.no.toString().padStart(2,"0")} ${t}`)}}return r}loadCue(e){if(this.tracks.length>0)throw"Loading again unsupported. Make a new object";e=i.normalize(e);s.log(`loadCue() :: Loading "${e}"`);if(i.extname(e).toLowerCase()!=".cue")throw`Not a ".cue" file`;let t=o.fileGet(e);if(t==null)throw`Cannot load file "${e}"`;let r=t.split("\n");for(let e=0;e<r.length;e++){let t=r[e].trim();if(t.length==0)continue;try{this._cueParser(t)}catch(t){throw`Cue Parse Error on Line (${e+1}) : ${t}`}}this.FILE_LOADED=i.resolve(e);this.FILE_DIR=i.dirname(this.FILE_LOADED);if(this.tracks.length==0)throw"No Tracks in the cue file";this.opentrack?.validCheck();if(!this.CD_TITLE){let t=/([^\/\\]*)\.cue$/i;this.CD_TITLE=t.exec(e)[1]}for(let e=0,t=null,r=null;e<this.tracks.length;e++){let s=this.tracks[e];let o=this.tracks[e+1];if(s.file){t=s;let e=i.join(this.FILE_DIR,t.file);if(!n.existsSync(e))throw`File "${t.file}" does not exist in .cue directory`;let o=n.statSync(e);r=o.size;this.CD_SIZE+=r}else{s.shared=t.file}if(o&&!o.file){o.byteStart=l[t.type]*o.indexes[0].toFrames();s.byteSize=o.byteStart-s.byteStart}else{s.byteSize=r-s.byteStart}}s.log("CD_TITLE:",this.CD_TITLE," | CD_SIZE:",this.CD_SIZE,"| Tracks:",this.tracks.length);for(let e of this.tracks)s.debug(""+e);s.debug("-".repeat(30))}_cueParser(e){let t=e.toUpperCase();if(t.startsWith("REM")||t.startsWith(";"))return;if(t.startsWith("TITLE")){let e=/^\w+\s+\"(.+)\"/;let r=e.exec(t);if(r==null)throw"Line error, Bad Syntax";if(this.opentrack!=null)this.opentrack.title=r[1];else this.CD_TITLE=o.sanitizePath(r[1]);return}if(t.startsWith("FILE")){let t=/.+\"(.+)\"\s+(.+)/;let r=t.exec(e);if(r==null)throw"Line error, Bad Syntax";if(!a.includes(r[2])){throw"Unsupported TRACK File Type "+r[2]}this.opentrack?.validCheck();this.openfile=r[1];return}if(t.startsWith("TRACK")){if(this.openfile==null&&this.tracks.length==0)throw"A FILE has not been defined before TRACK 01";this.opentrack?.validCheck();let e=/^\w+\s+(\d+)\s+(\S+)/;let r=e.exec(t);if(r==null)throw"Line error, Bad Syntax";for(let e of this.tracks){if(e.no==parseInt(r[1])){throw`Track ${r[1]} is already defined`}}if(!l.hasOwnProperty(r[2])){throw"Unsupported Track type "+r[2]}this.opentrack=new cdtrack;this.opentrack.no=parseInt(r[1]);this.opentrack.type=r[2].toUpperCase();this.opentrack.file=this.openfile;this.openfile=null;this.tracks.push(this.opentrack);return}if(t.startsWith("INDEX")){if(this.opentrack==null)throw"A Track is not defined yet";let e=/^\w+\s+(\d+)\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/;let r=e.exec(t);if(r==null)throw"Line error, Bad Syntax";if(this.opentrack.indexExists(parseInt(r[1]))){throw`Track ${this.opentrack.no} - Duplicate Index entry ${r[1]}`}this.opentrack.indexes.push(new cuetime(parseInt(r[1]),parseInt(r[2]),parseInt(r[3]),parseInt(r[4])));return}if(t.startsWith("PREGAP")){if(this.opentrack==null)throw"A Track is not defined yet";let e=/\w+\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/;let r=e.exec(t);if(r==null)throw"Line error, Bad Syntax";this.opentrack.pregap=new cuetime(0,parseInt(r[1]),parseInt(r[2]),parseInt(r[3]));return}}}class cdtrack{file=null;type=null;no=0;title=null;pregap=null;indexes=[];hash="-";byteStart=0;byteSize=0;shared=null;indexExists(e){return this.indexes.some((t=>t.no==e))}validCheck(){if(!this.indexExists(1))throw`TRACK ${this.no} has no INDEX`}toString(){let e=this.indexes.reduce(((e,t)=>""+e+","+t));return`Track #${this.no}, type:${this.type}, indexes:[${e}], b0:${this.byteStart}, b1:${this.byteSize}, file:${this.file}, hash:${this.hash}, share:${this.shared}`}get isData(){return this.type!="AUDIO"}get noStr(){return this.no.toString().padStart(2,"0")}}class cuetime{no;minutes;seconds;frames;constructor(e,t,r,i){this.no=e;this.minutes=t;this.seconds=r;this.frames=i}toFrames(){return this.seconds*75+this.minutes*60*75+this.frames;z}fromFrames(e){this.minutes=Math.floor(e/4500);this.seconds=Math.floor(e%4500/75);this.frames=e%75}toString(){return this.minutes.toString().padStart(2,"0")+":"+this.seconds.toString().padStart(2,"0")+":"+this.frames.toString().padStart(2,"0")}}e.exports=cdinfos},788:(e,t,r)=>{const i=r(139);const n=r(835);const{copyFields:s}=r(716);const o=r(17);const a=r(407);const l=40;var c={IP:{name:"app",ver:"0.1",desc:null,actions:{},options:{o:["-","y"],log:["-","y"]},require:{action:false,input:"no",output:"no",multi:true},help:{info:null,usage:null,post:null,ehelp:false}},action:null,option:{},input:[],output:null,executable:o.basename(process.argv[1]),_readArguments(){let e=this.IP;let t=2;let r="";if(process.argv.length==2&this.IP.help.ehelp)return"HELP";while((r=process.argv[t++])!=null){if(r.charAt(0)==="-"){r=r.slice(1);if(r=="help"||r=="-help")return"HELP";let i=e.options[r];if(!i)return`Illegal Option <red>-${r}<!>`;if(typeof i=="object"&&i[1]!=null){let e=process.argv[t++];if(!e)return`Option <yellow>-${r}<!> requires a parameter`;this.option[r]=e}else{this.option[r]=true}continue}if(e.actions[r]&&!this.action){this.action=r;continue}this.input.push(r)}this.output=this.option.o;delete this.option.o;if(!this.action)for(let t in e.actions)if(typeof e.actions[t]=="string"&&e.actions[t].charAt(0)=="!")this.action=t;if(e.require.action&&!this.action)return`Action is required`;let check=e=>{if(e=="yes")return true;if(e=="no")return false;return e.split(",").some((e=>e==this.action))};if(this.input.length==0&&check(e.require.input))return`Input is required`;if(!this.output&&check(e.require.output))return`Output is required`;if(this.input.length>1&&!e.require.multi)return`Multiple inputs not supported`;if(this.input[0].includes("*")){if(!e.require.multi)return`Wildwards * not supported.`;this.input=a.dirGlob0(this.input[0])}for(let[t,r]of Object.entries(e.options)){if(typeof r=="string"||r[1]==null){if(!(t in this.option)){this.option[t]=false}}}return null},init(e){n.reset();this.IP=s(e,this.IP);process.once("SIGINT",(()=>process.exit(1223)));process.once("exit",(e=>{i.log(`==> [EXIT] with code ${e}`);n.reset().setCur(true)}));i.log(`Creating App [ ${this.IP.name} ,v${this.IP.ver} ]`);var t=this._readArguments();if(t!=null){if(t=="HELP"){this.printHelp();process.exit(0)}this.printBanner();this.exitError(t,true)}let r=this.option.log;if(r)i.set({file:r.split("=").pop(),level:parseInt(r[0])});i.log("- Inputs :",this.input);i.log("- Output :",this.output);i.log("- Action :",this.action);i.log("- Options :",this.option);i.log("-".repeat(30))},printBanner(e){let t="cyan";let r=this.IP;n.n();n.ptag(`<:${t},black>==<!><${t},bold> ${r.name} <darkgreen>v${r.ver}<!>`);n.ptag(` <it,darkgray>${r.desc??""}<!,n>`);if(e&&r.help.info){n.ptag(r.help.info).n()}n.fg("darkgray").println("-".repeat(l)).reset()},printHelp(){this.printBanner(true);const e=2;let t=12;let r=this.IP;let sp=e=>" ".repeat(e);let i=Object.keys(r.actions).length>0;let s=Object.keys(r.options).length>e;let conv=(e,r="")=>{let i=e.split("<|>");i[0]+=r;return i.join(n._NL+sp(t))};n.ptag("<cyan> Program Usage:").n();let o="   "+this.executable+" ";if(i)o+="<action> ";if(s)o+="[<options>...] ";if(r.require.input!="no")o+=r.require.multi?"[<inputs>...] ":"<input> ";if(r.require.output!="no")o+="-o <output> ";n.ptag(`<bold,white>${o}<!,n>`);if(r.help.usage)n.ptag(r.help.usage).n();n.fg("darkgray").println("-".repeat(l));if(i){n.ptag("<cyan> <actions> <darkgray,it>(you can set one action at a time)<!,n>");for(let e in r.actions){let i="";let s=r.actions[e];if(s.charAt(0)=="-")continue;if(s.charAt(0)=="!"){s=s.slice(1);i=" <darkcyan,it>(default action)<!>"}n.ptag("<white,bold> "+e+"<!,gray>"+sp(t-e.length-1)+conv(s,i)).n()}}if(s){n.ptag("<cyan> <options> <darkgray,it>(you can set multiple options)<!,n>");for(let e in r.options){let i=typeof r.options[e]=="object"?r.options[e][0]:r.options[e];if(i.charAt(0)=="-")continue;let s=r.options[e][1]?" <darkcyan,it>(requires parameter)<!> "+(r.options[e][2]?`<darkgray,it>default(${r.options[e][2]})<!>`:""):"";n.ptag("<white,bold> -"+e+"<!,gray>"+sp(t-e.length-2)+conv(i,s)).n()}}if(r.help.post){n.fg("darkgray").println("-".repeat(l)).reset();n.ptag(r.help.post).n()}},exitError(e,t=false){n.ptag(`<:darkred,white> ERROR <!> ${e}<!,n>`);if(t){n.ptag("<darkgray>"+"-".repeat(l)).n();n.ptag("<yellow> -help <!> for usage info").n()}i.error("APP: EXIT ERROR : "+n.st(e));process.exit(1)}};e.exports=c},407:(e,t,r)=>{const i=r(147);const n=r(139);const s=r(17);t.sanitizePath=e=>e.replace(/[\\/:"*?<>|]/g,"");t.fileGet=e=>{let t;try{t=i.readFileSync(e,{encoding:"utf8"})}catch(e){return null}return t};t.copyPart=function(e,t,r=0,s=0,o="w"){return new Promise(((a,l)=>{let c;try{c=i.statSync(e)}catch(t){throw`Cannot read file '${e}'`}let u=c.size;if(s==0)s=u-r;else if(s+r>u){throw`Trying to copy more bytes than available in '${e}'`}let p=r+s-1;let h=i.createReadStream(e,{start:r,end:p,flags:"r"});h.once("error",(t=>l(`Could not read file '${e}'`)));let f=i.createWriteStream(t,{flags:o});f.once("error",(e=>l(`Could not write file '${t}'`)));n.debug(`Copying "${e}" BYTES [(from)::${r} (len)::${s} (end)::${p}] to "${t}"`);h.pipe(f);f.once("close",a)}))};t.dirGlob0=function(e,t){t=t??process.cwd();let r=s.parse(s.resolve(e));if(r.name!="*")return[];let o;try{o=i.readdirSync(r.dir,{withFileTypes:true})}catch(e){n.error(`dirGlobExt: Could not read "${base}"`);return[]}let a=[];o.forEach((e=>{if(e.isFile())if(!r.ext||r.ext&&e.name.endsWith(r.ext))a.push(s.relative(t,s.join(r.dir,e.name)))}));return a}},139:(e,t,r)=>{const i=r(17);const n=r(147);const s={date:"HH:MM:SS",pos:false,stderr:false,bufferSize:2e3,file:null,level:-1};let o=3;let a=[];let l=null;function set(e){Object.assign(s,e);if(s.file)setLogFile(s.file);if(s.level>=0){o=s.level;if(o<0)o=0;else if(o>4)o=4}}function setLogFile(e){if(l==e)return;l=e;let t="-".repeat(40);let r=` == LOG ==\n ${t}\n - LogFile : ${l}\n - Created : ${dateFormat("YYYY-mm-dd HH:MM:SS")} \n - Script  : ${process.argv[1]}\n ${t}\n`;try{n.writeFileSync(l,r)}catch(e){l=null;error(`Cannot Create Log File &{logFile}`);return}for(let e of a)pushFile(e)}let getStackTrace=function(){let e={};Error.captureStackTrace(e,getStackTrace);return e.stack};function pushFile(e){try{n.appendFileSync(l,e+"\n")}catch(e){l=null;error("Cannot write to LOG FILE")}}function dateFormat(e,t){if(!t)t=new Date;var r={"Y+":t.getFullYear().toString(),"m+":(t.getMonth()+1).toString(),"d+":t.getDate().toString(),"H+":t.getHours().toString(),"M+":t.getMinutes().toString(),"S+":t.getSeconds().toString()};for(let t in r){let i=new RegExp("("+t+")");let n=i.exec(e);if(n){e=e.replace(n[1],n[1].length==1?r[t]:r[t].padStart(n[1].length,"0"))}}return e}function logMain(...e){let t=e.shift()+" ";if(s.date){t+=`${dateFormat(s.date)}:`}if(s.pos){let e=getStackTrace();let r=e.match(/\(.*?\)/g)||[];let n=r[2]||"";let s=n.substring(n.lastIndexOf(i.sep)+1,n.length-1);t+=`(${s}) `}if(s.stderr){console.error(t,...e)}t+=e.reduce(((e,t)=>{if(typeof t=="object"){if(Array.isArray(t))return"["+t.toString()+"]";return e+" "+JSON.stringify(t,null,2)}else{if(typeof t=="function")return e+"";return e+" "+t}}));a.push(t);if(a.length>s.bufferSize)a.shift();if(l)pushFile(t)}function debug(){if(o<4)return;logMain("DEBUG",...arguments)}function log(){if(o<3)return;logMain("LOG",...arguments)}function warn(){if(o<2)return;logMain("WARNING",...arguments)}function error(){if(o<1)return;logMain("ERROR",...arguments)}e.exports={set:set,log:log,error:error,debug:debug,warn:warn,get BUFFER(){return a}}},155:(e,t,r)=>{const{spawn:i,ChildProcess:n,execSync:s}=r(81);const o=r(139);e.exports=class Proc2{static ID=0;exec;cwd;proc;onClose;logExit={err:"",out:"",code:0};log;onErr;onOut;constructor(e,t){this.id=++Proc2.ID;this.exec=e;this.cwd=t?.cwd;this.onClose=t?.onClose;this.log=t?.log;this.onErr=t?.onErr;this.onOut=t?.onOut}get stdin(){this.proc.stdin.once("error",(()=>{}));return this.proc.stdin}startP(e){return new Promise(((t,r)=>{this.onClose=e=>{if(e==0)return t();r(this.logExit)};this.start(e)}))}start(e){if(typeof e=="string")e=e.split("|");o.log(`AppRun (${this.id}): ${this.exec} ${e?e.join(" "):""} | cwd:${this.cwd??process.cwd()}`);let t=this.proc=i(this.exec,e,{cwd:this.cwd});t.once("error",(e=>{let t=this.logExit;o.error(`AppRun (${this.id}): ERROR ${e.message}`);if(e.message.endsWith("ENOENT")){t.err=`Cannot execute "${this.exec}"`;t.code=2;return}t.err=e.message;t.code=1}));t.once("exit",((e,r)=>{let i=t.stderr.read();let n=t.stdout.read();this.logExit={err:i?Buffer.from(i).toString():"",out:n?Buffer.from(n).toString():""}}));t.once("close",((e,t)=>{this.kill();let r=this.logExit;if(e==0){o.log(`AppRun (${this.id}): CLOSE - OK`);return this.onClose(0)}if(r.code>0)e=r.code;else r.code=e;o.error(`AppRun (${this.id}): CLOSE - Error Code : ${e}\n`+`\tstdErr : ...${r.err.slice(-128)}`+`\tstdOut : ...${r.out.slice(-128)}`);return this.onClose(e)}));if(this.onErr){t.stderr.setEncoding("utf8");t.stderr.on("data",this.onErr)}if(this.onOut){t.stdout.setEncoding("utf8");t.stdout.on("data",this.onOut)}if(this.log){this.log.err=this.log.out="";t.stderr.setEncoding("utf8");t.stderr.on("data",(e=>this.log.err+=e));t.stdout.setEncoding("utf8");t.stdout.on("data",(e=>this.log.out+=e))}}kill(){if(this.proc){this.proc.removeAllListeners();this.proc.kill();this.proc=null}}static checkRun(e){try{s(e,{timeout:5e3,stdio:"ignore"})}catch(e){return false}return true}}},437:(e,t,r)=>{const i=r(835);t.Prog={active:false,tick:250,timer:undefined,t_max:0,t_comp:0,t_str:"",c:1,cmax:7,start(e=0){i.saveCur();if(e>0)this.setTask(0,e);this.active=true;this.timer=setInterval(this.upd.bind(this),this.tick)},setTask(e,t){i.restCur().print(" ".repeat(this.t_str.length)).restCur();i.pac(this.t_str=`(${e}/${t}) `)},upd(){i.restCur();if(this.t_str){i.moveR(this.t_str.length,0)}i.clearLine(1).print(".".repeat(this.c));if(++this.c>this.cmax)this.c=1},stop(){if(!this.active)return false;clearInterval(this.timer);i.restCur().clearLine(1);this.active=false;return true}}},835:(e,t,r)=>{const{EOL:i}=r(37);const{stdout:n}=r(282);class Terminal{_ESC_SEQ="[";_BOLD="[1m";_DIM="[2m";_ITAL="[3m";_UNDERL="[4m";_BLINK="[5m";_HIDDEN="[8m";_RESET_ALL="[0m";_RESET_FG="[39m";_RESET_BG="[49m";_RESET_BOLD="[21m";_RESET_DIM="[22m";_RESET_ITAL="[23m";_RESET_UNDERL="[24m";_RESET_BLINK="[25m";_RESET_HIDDEN="[28m";_CURSOR_SAV="[s";_CURSOR_RES="[u";_NL=i;COLORS_FG=new Map([["darkgray","[90m"],["red","[91m"],["green","[92m"],["yellow","[93m"],["blue","[94m"],["magenta","[95m"],["cyan","[96m"],["white","[97m"],["black","[30m"],["darkred","[31m"],["darkgreen","[32m"],["darkyellow","[33m"],["darkblue","[34m"],["darkmagenta","[35m"],["darkcyan","[36m"],["gray","[37m"]]);COLORS_BG=new Map([["darkgray","[100m"],["red","[101m"],["green","[102m"],["yellow","[103m"],["blue","[104m"],["magenta","[105m"],["cyan","[106m"],["white","[107m"],["black","[40m"],["darkred","[41m"],["darkgreen","[42m"],["darkyellow","[43m"],["darkblue","[44m"],["darkmagenta","[45m"],["darkcyan","[46m"],["gray","[47m"]]);setCur(e){return this.print(e?"[?25h":"[?25l")}saveCur(){return this.print(this._CURSOR_SAV)}restCur(){return this.print(this._CURSOR_RES)}up(e=1){return this.print("[${x}A")}down(e=1){return this.print("[${x}B")}forward(e=1){return this.print("[${x}C")}back(e=1){return this.print("[${x}D")}move(e,t){process.stdout.cursorTo(e-1,t-1)}moveR(e,t){process.stdout.moveCursor(e,t)}print(e){n.write(e);return this}println(e){n.write(e+i);return this}clearLine(e=0){n.clearLine(e);return this}fg(e){if(!e)return this.print(this._RESET_FG);return this.print(this.COLORS_FG.get(e))}bg(e){if(!e)return this.print(this._RESET_BG);return this.print(this.COLORS_BG.get(e))}reset(){return this.print(this._RESET_ALL)}endl(){return this.print(i)}n(e=1){return this.print(i.repeat(e))}ptag(e){return this.print(this.parseTags(e))}parseTags(e){const t=/<(\S+?)>/g;e=e.replace(t,((e,t)=>{let r=t.split(",");let n="";for(let t of r){switch(t){case"n":n+=i;break;case"t":n+="\t";break;case"!":n+=this._RESET_ALL;break;case"!fg":n+=this._RESET_ALL;break;case"!bg":n+=this._RESET_ALL;break;case"cs":n+=this._CURSOR_SAV;break;case"cr":n+=this._CURSOR_RES;break;case"bold":n+=this._BOLD;break;case"!bold":n+=this._RESET_BOLD;break;case"underl":n+=this._UNDERL;break;case"!underl":n+=this._RESET_UNDERL;break;case"it":n+=this._ITAL;break;case"!it":n+=this._RESET_ITAL;break;default:if(t.indexOf(":")==0){let r=t.split(":")[1];if(this.COLORS_BG.has(r)){n+=this.COLORS_BG.get(r)}else{throw new Error(`Tag Error: Color Error ${e}`)}}else{if(this.COLORS_FG.get(t)){n+=this.COLORS_FG.get(t)}else{n+=e}}}}return n}));return e}st(e){return e.replace(/<(\S+?)>/g,"")}pac(e){return this.ptag(this.autoColor(e))}autoColor(e){let t=/\b(\d+)|\[(.+?)\]|\{(.+?)\}|'(.+?)'|"(.+?)"|([\-+=:()?<>]+)/g;return e.replace(t,((e,t,r,i,n,s,o)=>{if(t)return`<cyan>${e}<!>`;if(r)return`<green,bold>${e}<!>`;if(i)return`<red,bold>${e}<!>`;if(n)return`<magenta,it>${e}<!>`;if(s)return`<yellow>${e}<!>`;if(o)return`<yellow,bold>${e}<!>`;return"X"}))}}e.exports=new Terminal},716:(e,t,r)=>{const i=r(139);t.copyFields=(e,r)=>{if(e==null)return r;if(r==null)r={};for(let i in e){if(e[i]instanceof Array){Reflect.set(r,i,[...e[i]])}else if(typeof e[i]=="object"){Reflect.set(r,i,t.copyFields(e[i],r[i]))}else{Reflect.set(r,i,e[i])}}return r};t.clamp=(e,t,r)=>Math.min(Math.max(e,t),r);t.randomInt=(e,t)=>Math.round(Math.random()*(t-e))+e;t.randomNum=(e,t)=>e+(e-t)*Math.random();t.bytesToMBStr=e=>""+Math.ceil(e/(1024*1024));t.roundFloat=(e,t=2)=>{e*=Math.pow(10,t);return Math.round(e)/Math.pow(10,t)};Object.defineProperty(Array.prototype,"last",{value:function(e=1){if(this==null){throw new TypeError("this is null or not defined")}if(this.length==0)return undefined;if(this.length-e<0)return this[0];return this[this.length-e]},writable:false,enumerable:false,configurable:false});Object.defineProperty(Array.prototype,"queueRun",{value:function(e){const t=this;const q=()=>{let r=t.shift();e.call(t,r,(()=>{process.nextTick(q)}))};q()},writable:true,enumerable:false,configurable:true});t.PromiseRun=(e,t=4,r)=>new Promise(((n,s)=>{let o=0;let a=0;let l=null;function tryAdd(){if(l){if(o==0){i.error(`PromiseRun -- END WITH ERRORS (${l.length}) -- Run (${a})`);return s(l)}return}let t=e.next();if(t.done){if(o==0){i.log(`PromiseRun -- END -- ALL (${a}) SETTLED`);return n()}return}o++;t.value.catch((e=>{if(!l)l=[];if(e instanceof Error){l.push(e.message)}else{l.push(e)}})).finally((()=>{a++;o--;i.debug(`PromiseRun -- Completed (${a}) `);if(typeof r=="function")r(a);tryAdd()}))}i.log(`PromiseRun -- START -- Max parallel (${t})`);while(t--)tryAdd()}))},81:e=>{"use strict";e.exports=require("child_process")},206:e=>{"use strict";e.exports=require("console")},113:e=>{"use strict";e.exports=require("crypto")},147:e=>{"use strict";e.exports=require("fs")},37:e=>{"use strict";e.exports=require("os")},17:e=>{"use strict";e.exports=require("path")},282:e=>{"use strict";e.exports=require("process")}};var t={};function __nccwpck_require__(r){var i=t[r];if(i!==undefined){return i.exports}var n=t[r]={exports:{}};var s=true;try{e[r](n,n.exports,__nccwpck_require__);s=false}finally{if(s)delete t[r]}return n.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var r={};(()=>{const e=__nccwpck_require__(147);const t=__nccwpck_require__(17);const{cpus:r}=__nccwpck_require__(37);const i=__nccwpck_require__(788);const n=__nccwpck_require__(835);const s=__nccwpck_require__(437);const o=__nccwpck_require__(139);const a=__nccwpck_require__(716);const l=__nccwpck_require__(407);const c=__nccwpck_require__(155);const u=__nccwpck_require__(382);const{trace:p}=__nccwpck_require__(206);const h=Math.ceil(r().length*.75);const f={rawStr:"-f|s16le|-ar|44100|-ac|2",enc:{MP3:{name:"Mp3",ext:".mp3",pf:"k Cbr",min:32,max:320,get(e){return`-c:a|libmp3lame|-b:a|${e}k`}},MP3V:{name:"Mp3",ext:".mp3",pf:"k Vbr",min:44,max:256,get(e){return"-c:a|libmp3lame|-q:a|"+a.clamp(9-Math.round(9*(e-44)/212),0,9)}},VORBIS:{name:"Vorbis",ext:".ogg",pf:"k Vbr",min:64,max:500,get(e){let t=[64,80,96,112,128,160,192,224,256,320,500],r=0;while(e>t[r++]);if(r>10)r=10;let i=t[r-1];let n=(e-i)/(t[r]-i);return"-c:a|libvorbis|-q|"+a.roundFloat(r-1+n,2)}},OPUS:{name:"Opus",ext:".opus",pf:"k Vbr",min:28,max:500,get(e){return`-c:a|libopus|-vbr|on|-compression_level|10|-b:a|${e}k`}},FLAC:{name:"Flac Lossless",ext:".flac",get(){return"-c:a|flac"}},RAW:{name:"CDDA Raw",ext:".bin",get(){return"-c:a|pcm_s16le|-f|s16le|-ar|44100|-ac|2"}}},getEnc:function(e){if(!e)return null;let t=e.toUpperCase().split(":");let r=this.enc[t[0]];if(!r)return null;let i={ext:r.ext,desc:r.name,str:null};let n=parseInt(t[1]);if(Number.isNaN(n)){if(r.max)return null}if(r.max){n=a.clamp(n,r.min,r.max);i.desc+=` ${n}${r.pf}`}i.str=r.get(n);return i}};function FilePartSHA1(t,r=0,i=0){return new Promise(((n,s)=>{let a;try{a=e.statSync(t)}catch(e){throw`Cannot read file '${t}'`}let l=a.size;if(i==0)i=l-r;let c=r+i-1;o.debug("Reading SHA1 for ",t,r,c);let u=e.createReadStream(t,{start:r,end:c,flags:"r"});u.once("error",(e=>s(`Could not read file '${t}'`)));var p=__nccwpck_require__(113);var h=p.createHash("sha1");u.on("readable",(()=>{let e=u.read();if(e)h.update(e);else n(h.digest("hex"))}))}))}function createOuputDir(r,i){let n=i??r.FILE_DIR;n=t.resolve(t.normalize(n));n=t.join(n,r.CD_TITLE);n+=" [e]";if(m){n+=` [only ${m}]`}while(e.existsSync(n)){let e=/\((\d+)\)$/.exec(n);if(!e){n+=" (2)"}else{n=n.slice(0,e.index);n+="("+(parseInt(e[1])+1)+")"}}o.log(`Creating CD output dir "${n}"`);try{e.mkdirSync(n,{recursive:true})}catch(e){o.error(" .. FAILED");throw`Cannot create : "${n}"`}return n}function printEStats(e){let t=g.inputs.length;if(t<2)return;n.pac(` >> 'Input' (${t}) Cue Files\n`);n.pac(` >> [Encoded] (${g.success}/${t}) \n`);let func=(e,r)=>{if(e.size){n.pac(` >> ${r[0]} (${e.size}/${t}) ${r[1]}`);let i=0;e.forEach(((e,t)=>{n.pac(`\t${++i}.'${g.inputs[t]}' -- {${e}}\n`)}))}};func(g.skip,["{Skipped}","\n"]);func(g.error,["{Failed}","\n"]);n.n();if(e){n.ptag("<:darkmagenta,white> >> USER ABORTED  <!,n>")}}function taskEncodeCD(r){return new Promise(((p,_)=>{let y=Date.now();let E=new u;E.loadCue(r);if(E.tracks.every((e=>e.isData)))throw"+CD has no Audio Tracks";let S=0;let k=i.output;if(k=="=src")k=null;let w=createOuputDir(E,k);let b=E.CD_TITLE+" - Track ";let $="  - ";n.pac(`${$}Output : "${w}"\n`);if(m=="data"){n.pac(`${$}Processing `)}else{n.pac(`${$}Audio Enc : '${d.desc}'\n`);if(d.ext==".bin")n.pac(`${$}Copying Tracks `);else n.pac(`${$}Converting Tracks `)}s.Prog.start(E.tracks.length);const gen=function*(){for(let r=0;r<E.tracks.length;r++){let i=E.tracks[r];let n=t.join(w,b+i.noStr);let s=i.isData||d.ext==".bin";if(i.isData&&m=="audio"||!i.isData&&m=="data"){yield new Promise((e=>e()));continue}if(s){S+=i.byteSize;yield l.copyPart(E.getTrackFilePath(r),`${n}.bin`,i.byteStart,i.byteSize)}else{let t=e.createReadStream(E.getTrackFilePath(r),{start:i.byteStart,end:i.byteStart+i.byteSize-1,flags:"r"});let s=new c("ffmpeg");let o=s.startP(`-y|${f.rawStr}|-i|pipe:0|${d.str}|${n+d.ext}`);s.proc.prependListener("close",(e=>{let t=s.logExit.err.slice(-120);let r=/audio:(\d+)kB/.exec(t);if(r)S+=parseInt(r[1])*1024}));t.pipe(s.stdin);yield o}}return 0};a.PromiseRun(gen(),i.option.p??h,(e=>{s.Prog.setTask(e,E.tracks.length)})).then((()=>{s.Prog.stop();if(m){n.pac(`[OK]\n`);n.pac($+"{Partial!} Skipping .cue file\n");g.success++;return}byteStr=`${a.bytesToMBStr(E.CD_SIZE)}MB -> ${a.bytesToMBStr(S)}MB`;n.pac(`[OK]\n`);n.pac($+`CD Size : `+byteStr);n.ptag("<darkgray,it> | time "+new Date(Date.now()-y+500).toISOString().slice(14,19).replace(":","m:")+"s<!,n>");let r=["REM "+"-".repeat(50)];r.push("REM | "+E.CD_TITLE);r.push(r[0]);r.push(`REM | Converted with CBAE v${i.IP.ver} - Cue/Bin Audio Encoder`);r.push(`REM | CD Size : ${byteStr}`);r.push("REM | Audio Quality : "+d.desc);r.push(r[0],"");r=r.concat(E.generateCueForEncoded(b,d.ext));let l=E.CD_TITLE+".cue";try{o.log("> All tracks Complete. Writing CUE file");e.writeFileSync(t.join(w,l),r.join("\n"))}catch(e){throw[`Failed to write : '${l}'`]}g.success++;g.size0+=E.CD_SIZE;g.size1+=S})).catch((t=>{if(s.Prog.stop()){n.n()}e.renameSync(w,`${w} (${Date.now()}) (failed)`);t=t[0];if(typeof t=="string"){_(t)}else{_("FFmpeg general error. Not enough disk space?")}})).then(p)}))}i.init({name:"CBAE",ver:"1.0",desc:"Cue/Bin Audio Encoder",actions:{e:"!Encode cue/bin to output folder. Will create the new<|>track files and the new .cue file under a subfolder",i:"Display cue/bin information along with SHA1 checksum of tracks "},options:{enc:["Audio Codec String <yellow>ID:KBPS<!> <|>"+"List of supported Encoders:<|>"+"<yellow>MP3<!>:(32-320) Constant Bitrate | <yellow>MP3V<!>:(44-256) Variable Bitrate <|>"+"<yellow>VORBIS<!>:(64-500) | <yellow>OPUS<!>:(28-500) | <yellow>FLAC<!> | <yellow>RAW<!> <|>"+"<darkgray,it> e.g. -enc OPUS:64 , -enc FLAC, -enc VORBIS:320<!>",1],p:["Set max parallel operations.",1,h],only:["Process only <yellow>{data, audio}<!> from the tracks<|>For advanced use, does not generate a .cue file <darkgray>| e.g. -only audio<!>",1]},help:{ehelp:true,info:"<darkgray>  Author : John32B | https://github.com/john32b/cbae <!,n>"+"  Encodes the Audio Tracks of a cue/bin CD image and builds a new .cue file",sage:"<t,magenta>input:<!> .cue files only. Supports multiple files.<n,t,magenta>output:<!> A new folder will be created for each cue/bin in this folder.<n,t,t>You can use <yellow>=src<!> for source folder",post:"<magenta>Notes:<!,darkgray>\tUsing the <darkyellow>RAW<darkgray> encoder will just copy the audio tracks as they are,<n>\tthis is useful for cutting .bin files to individual track files."},require:{input:"yes",output:"e,d"}});var d;var g={inputs:null,success:0,error:new Map,skip:new Map,size0:0,size1:0};n.setCur(false);i.printBanner();var m=i.option.only;if(m=="data")i.option.enc="RAW";if(i.input.length==0){n.pac(" > No input files \n");process.exit(0)}if(i.action=="i"){o.log("> Action: Information ::");let e=i.input.length;let t=0;i.input.queueRun(((r,i)=>{if(!r){process.exit(0)}let s=e>1?`(${++t}/${e}) `:"";n.pac(`\n==> Input ${s} : "${r}"\n`);let l=new u;try{l.loadCue(r)}catch(e){o.error(e);n.pac(`  > {ERROR} : ${e}\n`);return i()}let c=a.bytesToMBStr;let p=l.getAudioSize();n.pac(`  > CD Title:'${l.CD_TITLE}' | Size:${c(l.CD_SIZE)}MB (Data:${c(l.CD_SIZE-p)}MB Audio:${c(p)}MB) | Tracks ${l.tracks.length}\n`);[...l.tracks].queueRun(((e,t)=>{if(!e)return i();n.pac(`\t> Track${e.noStr} | Type:${e.type.padEnd(10)} | `);FilePartSHA1(l.getTrackFilePath(e.no-1),e.byteStart,e.byteSize).then((t=>{n.pac(`Size:${c(e.byteSize).padStart(3)}MB | SHA1: ${t}\n`)})).catch((e=>{n.pac(`{ ERROR READING } | file ${file} \n`)})).finally(t)}))}))}if(i.action=="e"){o.log("> Action: Encode ::");g.inputs=[...i.input];let e=i.input.length;let t=0;let printLine=()=>n.ptag("  <darkgray>"+"-".repeat(40)+"<!,n>");try{if(!c.checkRun("ffmpeg -version"))throw"Cannot run ffmpeg. Is it set on path?";if(!i.option.enc)throw"You need to set an encoder with '-enc'";d=f.getEnc(i.option.enc);if(!d)throw"Encoding String Error."}catch(e){i.exitError(n.autoColor(e))}process.prependOnceListener("exit",(e=>{s.Prog.stop();if(e==1223){n.ptag("<:darkmagenta,white> USER ABORT <!,n>");printLine()}printEStats(e==1223)}));i.input.queueRun(((r,i)=>{if(!r){process.exit(0)}let s=e>1?`(${t+1}/${e}) `:"";n.pac(`==> Input ${s} : "${r}"\n`);taskEncodeCD(r).catch((e=>{let r;if(e.charAt(0)=="+"){e=e.slice(1);g.skip.set(t,e);r="{warning}"}else{g.error.set(t,e);r="{ERROR}"}o.error(e);n.pac(`\t${r} : ${e}`).ptag(" | <cyan,it>skipping<!,n>")})).then((()=>{t++;printLine();i()}))}))}})();module.exports=r})();