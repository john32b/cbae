#! /usr/bin/env node
(()=>{var t={84:(t,e,r)=>{const i=r(17);const n=r(147);const s=r(307);const o=r(216);const a=["BINARY","WAVE"];const l={AUDIO:2352,CDG:2448,MODE1_RAW:2352,"MODE1/2048":2048,"MODE1/2352":2352,MODE2_RAW:2352,"MODE2/2048":2048,"MODE2/2324":2324,"MODE2/2336":2336,"MODE2/2352":2352,"CDI/2336":2336,"CDI/2352":2352};class cdinfos{CD_TITLE;CD_SIZE=0;FILE_LOADED=null;FILE_DIR=null;tracks=[];opentrack=null;openfile=null;constructor(t){if(t)this.loadCue(t)}getTrackFilePath(t){return i.join(this.FILE_DIR,this.tracks[t].file??this.tracks[t].shared)}getAudioSize(){return this.tracks.reduce(((t,e)=>t+(e.isData?0:e.byteSize)),0)}generateCueForEncoded(t,e){let r=[];for(let i of this.tracks){let n=`${i.no}`.padStart(2,"0");let s=t+n;if(i.isData){r.push(`\tFILE "${s}.bin" BINARY`)}else{let t=e.slice(1).toUpperCase();r.push(`\tFILE "${s+e}" ${t}`)}r.push(`\t\tTRACK ${n} ${i.type}`);if(i.pregap)r.push(`\t\tPREGAP ${i.pregap}`);let o=i.indexes[0].toFrames();for(let t of i.indexes){let e=new cuetime(t.no,0,0,0);e.fromFrames(t.toFrames()-o);r.push(`\t\tINDEX ${e.no.toString().padStart(2,"0")} ${e}`)}}return r}loadCue(t){if(this.tracks.length>0)throw"Loading again unsupported. Make a new object";t=i.normalize(t);s.log(`loadCue() :: Loading "${t}"`);if(i.extname(t).toLowerCase()!=".cue")throw`Not a ".cue" file`;let e=o.fileGet(t);if(e==null)throw`Cannot load file "${t}"`;let r=e.split("\n");for(let t=0;t<r.length;t++){let e=r[t].trim();if(e.length==0)continue;try{this._cueParser(e)}catch(e){throw`Cue Parse Error on Line (${t+1}) : ${e}`}}this.FILE_LOADED=i.resolve(t);this.FILE_DIR=i.dirname(this.FILE_LOADED);if(this.tracks.length==0)throw"No Tracks in the cue file";this.opentrack?.validCheck();if(!this.CD_TITLE){let e=/([^\/\\]*)\.cue$/i;this.CD_TITLE=e.exec(t)[1]}for(let t=0,e=null,r=null;t<this.tracks.length;t++){let s=this.tracks[t];let o=this.tracks[t+1];if(s.file){e=s;let t=i.join(this.FILE_DIR,e.file);if(!n.existsSync(t))throw`File "${e.file}" does not exist in .cue directory`;let o=n.statSync(t);r=o.size;this.CD_SIZE+=r}else{s.shared=e.file}if(o&&!o.file){o.byteStart=l[e.type]*o.indexes[0].toFrames();s.byteSize=o.byteStart-s.byteStart}else{s.byteSize=r-s.byteStart}}s.log("CD_TITLE:",this.CD_TITLE," | CD_SIZE:",this.CD_SIZE,"| Tracks:",this.tracks.length);for(let t of this.tracks)s.debug(""+t);s.debug("-".repeat(30))}_cueParser(t){let e=t.toUpperCase();if(e.startsWith("REM")||e.startsWith(";"))return;if(e.startsWith("TITLE")){let t=/^\w+\s+\"(.+)\"/;let r=t.exec(e);if(r==null)throw"Line error, Bad Syntax";if(this.opentrack!=null)this.opentrack.title=r[1];else this.CD_TITLE=o.sanitizePath(r[1]);return}if(e.startsWith("FILE")){let e=/.+\"(.+)\"\s+(.+)/;let r=e.exec(t);if(r==null)throw"Line error, Bad Syntax";if(!a.includes(r[2])){throw"Unsupported TRACK File Type "+r[2]}this.opentrack?.validCheck();this.openfile=r[1];return}if(e.startsWith("TRACK")){if(this.openfile==null&&this.tracks.length==0)throw"A FILE has not been defined before TRACK 01";this.opentrack?.validCheck();let t=/^\w+\s+(\d+)\s+(\S+)/;let r=t.exec(e);if(r==null)throw"Line error, Bad Syntax";for(let t of this.tracks){if(t.no==parseInt(r[1])){throw`Track ${r[1]} is already defined`}}if(!l.hasOwnProperty(r[2])){throw"Unsupported Track type "+r[2]}this.opentrack=new cdtrack;this.opentrack.no=parseInt(r[1]);this.opentrack.type=r[2].toUpperCase();this.opentrack.file=this.openfile;this.openfile=null;this.tracks.push(this.opentrack);return}if(e.startsWith("INDEX")){if(this.opentrack==null)throw"A Track is not defined yet";let t=/^\w+\s+(\d+)\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/;let r=t.exec(e);if(r==null)throw"Line error, Bad Syntax";if(this.opentrack.indexExists(parseInt(r[1]))){throw`Track ${this.opentrack.no} - Duplicate Index entry ${r[1]}`}this.opentrack.indexes.push(new cuetime(parseInt(r[1]),parseInt(r[2]),parseInt(r[3]),parseInt(r[4])));return}if(e.startsWith("PREGAP")){if(this.opentrack==null)throw"A Track is not defined yet";let t=/\w+\s+(\d{1,2}):(\d{1,2}):(\d{1,2})/;let r=t.exec(e);if(r==null)throw"Line error, Bad Syntax";this.opentrack.pregap=new cuetime(0,parseInt(r[1]),parseInt(r[2]),parseInt(r[3]));return}}}class cdtrack{file=null;type=null;no=0;title=null;pregap=null;indexes=[];hash="-";byteStart=0;byteSize=0;shared=null;indexExists(t){return this.indexes.some((e=>e.no==t))}validCheck(){if(!this.indexExists(1))throw`TRACK ${this.no} has no INDEX`}toString(){let t=this.indexes.reduce(((t,e)=>""+t+","+e));return`Track #${this.no}, type:${this.type}, indexes:[${t}], b0:${this.byteStart}, b1:${this.byteSize}, file:${this.file}, hash:${this.hash}, share:${this.shared}`}get isData(){return this.type!="AUDIO"}get noStr(){return this.no.toString().padStart(2,"0")}}class cuetime{no;minutes;seconds;frames;constructor(t,e,r,i){this.no=t;this.minutes=e;this.seconds=r;this.frames=i}toFrames(){return this.seconds*75+this.minutes*60*75+this.frames;z}fromFrames(t){this.minutes=Math.floor(t/4500);this.seconds=Math.floor(t%4500/75);this.frames=t%75}toString(){return this.minutes.toString().padStart(2,"0")+":"+this.seconds.toString().padStart(2,"0")+":"+this.frames.toString().padStart(2,"0")}}t.exports=cdinfos},513:(t,e,r)=>{const i=r(307);const n=r(656);const{copyFields:s}=r(857);const o=r(17);const a=r(216);const l=40;var c={IP:{name:"app",ver:"0.1",desc:null,actions:{},options:{o:["-","y"],log:["-","y"]},require:{action:false,input:"no",output:"no",multi:true},help:{info:null,usage:null,post:null,ehelp:false}},action:null,option:{},input:[],output:null,executable:o.basename(process.argv[1]),_readArguments(){let t=this.IP;let e=2;let r="";if(process.argv.length==2&this.IP.help.ehelp)return"HELP";while((r=process.argv[e++])!=null){if(r.charAt(0)==="-"){r=r.slice(1);if(r=="help")return"HELP";let i=t.options[r];if(!i)return`Illegal Option <red>-${r}<!>`;if(typeof i=="object"&&i[1]!=null){let t=process.argv[e++];if(!t)return`Option <yellow>-${r}<!> requires a parameter`;this.option[r]=t}else{this.option[r]=true}continue}if(t.actions[r]&&!this.action){this.action=r;continue}this.input.push(r)}this.output=this.option.o;delete this.option.o;if(!this.action)for(let e in t.actions)if(typeof t.actions[e]=="string"&&t.actions[e].charAt(0)=="!")this.action=e;if(t.require.action&&!this.action)return`Action is required`;let check=t=>{if(t=="yes")return true;if(t=="no")return false;return t.split(",").some((t=>t==this.action))};if(this.input.length==0&&check(t.require.input))return`Input is required`;if(!this.output&&check(t.require.output))return`Output is required`;if(this.input.length>1&&!t.require.multi)return`Multiple inputs not supported`;if(this.input[0].includes("*")){if(!t.require.multi)return`Wildwards * not supported.`;this.input=a.dirGlob0(this.input[0])}for(let[e,r]of Object.entries(t.options)){if(typeof r=="string"||r[1]==null){if(!(e in this.option)){this.option[e]=false}}}return null},init(t){n.reset();this.IP=s(t,this.IP);process.once("SIGINT",(()=>process.exit(1223)));process.once("exit",(t=>{i.log(`==> [EXIT] with code ${t}`);n.reset().setCur(true)}));i.log(`Creating App [ ${this.IP.name} ,v${this.IP.ver} ]`);var e=this._readArguments();if(e!=null){if(e=="HELP"){this.printHelp();process.exit(0)}this.printBanner();this.exitError(e,true)}let r=this.option.log;if(r)i.set({file:r.split("=").pop(),level:parseInt(r[0])});i.log("- Inputs :",this.input);i.log("- Output :",this.output);i.log("- Action :",this.action);i.log("- Options :",this.option);i.log("-".repeat(30))},printBanner(t){let e="cyan";let r=this.IP;n.n();n.ptag(`<:${e},black>==<!><${e},bold> ${r.name} <darkgreen>v${r.ver}<!>`);n.ptag(` <it,darkgray>${r.desc??""}<!,n>`);if(t&&r.help.info){n.ptag(r.help.info).n()}n.fg("darkgray").println("-".repeat(l)).reset()},printHelp(){this.printBanner(true);const t=2;let e=12;let r=this.IP;let sp=t=>" ".repeat(t);let i=Object.keys(r.actions).length>0;let s=Object.keys(r.options).length>t;let conv=(t,r="")=>{let i=t.split("<|>");i[0]+=r;return i.join(n._NL+sp(e))};n.ptag("<cyan> Program Usage:").n();let o="   "+this.executable+" ";if(i)o+="<action> ";if(s)o+="[<options>...] ";if(r.require.input!="no")o+=r.require.multi?"[<inputs>...] ":"<input> ";if(r.require.output!="no")o+="-o <output> ";n.ptag(`<bold,white>${o}<!,n>`);if(r.help.usage)n.ptag(r.help.usage).n();n.fg("darkgray").println("-".repeat(l));if(i){n.ptag("<cyan> <actions> <darkgray,it>(you can set one action at a time)<!,n>");for(let t in r.actions){let i="";let s=r.actions[t];if(s.charAt(0)=="-")continue;if(s.charAt(0)=="!"){s=s.slice(1);i=" <darkcyan,it>(default action)<!>"}n.ptag("<white,bold> "+t+"<!,gray>"+sp(e-t.length-1)+conv(s,i)).n()}}if(s){n.ptag("<cyan> <options> <darkgray,it>(you can set multiple options)<!,n>");for(let t in r.options){let i=typeof r.options[t]=="object"?r.options[t][0]:r.options[t];if(i.charAt(0)=="-")continue;let s=r.options[t][1]?" <darkcyan,it>(requires parameter)<!> "+(r.options[t][2]?`<darkgray,it>default(${r.options[t][2]})<!>`:""):"";n.ptag("<white,bold> -"+t+"<!,gray>"+sp(e-t.length-2)+conv(i,s)).n()}}if(r.help.post){n.fg("darkgray").println("-".repeat(l)).reset();n.ptag(r.help.post).n()}},exitError(t,e=false){n.ptag(`<:darkred,white> ERROR <!> ${t}<!,n>`);if(e){n.ptag("<darkgray>"+"-".repeat(l)).n();n.ptag("<yellow> -help <!> for usage info").n()}i.error("APP: EXIT ERROR : "+n.st(t));process.exit(1)}};t.exports=c},216:(t,e,r)=>{const i=r(147);const n=r(307);const s=r(17);e.sanitizePath=t=>t.replace(/[\\/:"*?<>|]/g,"");e.fileGet=t=>{let e;try{e=i.readFileSync(t,{encoding:"utf8"})}catch(t){return null}return e};e.copyPart=function(t,e,r=0,s=0,o="w"){return new Promise(((a,l)=>{let c;try{c=i.statSync(t)}catch(e){throw`Cannot read file '${t}'`}let u=c.size;if(s==0)s=u-r;else if(s+r>u){throw`Trying to copy more bytes than available in '${t}'`}let p=r+s-1;let h=i.createReadStream(t,{start:r,end:p,flags:"r"});h.once("error",(e=>l(`Could not read file '${t}'`)));let f=i.createWriteStream(e,{flags:o});f.once("error",(t=>l(`Could not write file '${e}'`)));n.debug(`Copying "${t}" BYTES [(from)::${r} (len)::${s} (end)::${p}] to "${e}"`);h.pipe(f);f.once("close",a)}))};e.dirGlob0=function(t,e){e=e??process.cwd();let r=s.parse(s.resolve(t));if(r.name!="*")return[];let o;try{o=i.readdirSync(r.dir,{withFileTypes:true})}catch(t){n.error(`dirGlobExt: Could not read "${base}"`);return[]}let a=[];o.forEach((t=>{if(t.isFile())if(!r.ext||r.ext&&t.name.endsWith(r.ext))a.push(s.relative(e,s.join(r.dir,t.name)))}));return a}},307:(t,e,r)=>{const i=r(17);const n=r(147);const s={date:"HH:MM:SS",pos:false,stderr:false,bufferSize:2e3,file:null,level:-1};let o=3;let a=[];let l=null;function set(t){Object.assign(s,t);if(s.file)setLogFile(s.file);if(s.level>=0){o=s.level;if(o<0)o=0;else if(o>4)o=4}}function setLogFile(t){if(l==t)return;l=t;let e="-".repeat(40);let r=` == LOG ==\n ${e}\n - LogFile : ${l}\n - Created : ${dateFormat("YYYY-mm-dd HH:MM:SS")} \n - Script  : ${process.argv[1]}\n ${e}\n`;try{n.writeFileSync(l,r)}catch(t){l=null;error(`Cannot Create Log File &{logFile}`);return}for(let t of a)pushFile(t)}let getStackTrace=function(){let t={};Error.captureStackTrace(t,getStackTrace);return t.stack};function pushFile(t){try{n.appendFileSync(l,t+"\n")}catch(t){l=null;error("Cannot write to LOG FILE")}}function dateFormat(t,e){if(!e)e=new Date;var r={"Y+":e.getFullYear().toString(),"m+":(e.getMonth()+1).toString(),"d+":e.getDate().toString(),"H+":e.getHours().toString(),"M+":e.getMinutes().toString(),"S+":e.getSeconds().toString()};for(let e in r){let i=new RegExp("("+e+")");let n=i.exec(t);if(n){t=t.replace(n[1],n[1].length==1?r[e]:r[e].padStart(n[1].length,"0"))}}return t}function logMain(...t){let e=t.shift()+" ";if(s.date){e+=`${dateFormat(s.date)}:`}if(s.pos){let t=getStackTrace();let r=t.match(/\(.*?\)/g)||[];let n=r[2]||"";let s=n.substring(n.lastIndexOf(i.sep)+1,n.length-1);e+=`(${s}) `}if(s.stderr){console.error(e,...t)}e+=t.reduce(((t,e)=>{if(typeof e=="object"){if(Array.isArray(e))return"["+e.toString()+"]";return t+" "+JSON.stringify(e,null,2)}else{if(typeof e=="function")return t+"";return t+" "+e}}));a.push(e);if(a.length>s.bufferSize)a.shift();if(l)pushFile(e)}function debug(){if(o<4)return;logMain("DEBUG",...arguments)}function log(){if(o<3)return;logMain("LOG",...arguments)}function warn(){if(o<2)return;logMain("WARNING",...arguments)}function error(){if(o<1)return;logMain("ERROR",...arguments)}t.exports={set:set,log:log,error:error,debug:debug,warn:warn,get BUFFER(){return a}}},355:(t,e,r)=>{const{spawn:i,ChildProcess:n,execSync:s}=r(81);const o=r(307);t.exports=class Proc2{static ID=0;exec;cwd;proc;onClose;logExit={err:"",out:"",code:0};log;onErr;onOut;constructor(t,e){this.id=++Proc2.ID;this.exec=t;this.cwd=e?.cwd;this.onClose=e?.onClose;this.log=e?.log;this.onErr=e?.onErr;this.onOut=e?.onOut}get stdin(){this.proc.stdin.once("error",(()=>{}));return this.proc.stdin}startP(t){return new Promise(((e,r)=>{this.onClose=t=>{if(t==0)return e();r(this.logExit)};this.start(t)}))}start(t){if(typeof t=="string")t=t.split("|");o.log(`AppRun (${this.id}): ${this.exec} ${t?t.join(" "):""} | cwd:${this.cwd??process.cwd()}`);let e=this.proc=i(this.exec,t,{cwd:this.cwd});e.once("error",(t=>{let e=this.logExit;o.error(`AppRun (${this.id}): ERROR ${t.message}`);if(t.message.endsWith("ENOENT")){e.err=`Cannot execute "${this.exec}"`;e.code=2;return}e.err=t.message;e.code=1}));e.once("exit",((t,r)=>{let i=e.stderr.read();let n=e.stdout.read();this.logExit={err:i?Buffer.from(i).toString():"",out:n?Buffer.from(n).toString():""}}));e.once("close",((t,e)=>{this.kill();let r=this.logExit;if(t==0){o.log(`AppRun (${this.id}): CLOSE - OK`);return this.onClose(0)}if(r.code>0)t=r.code;else r.code=t;o.error(`AppRun (${this.id}): CLOSE - Error Code : ${t}\n`+`\tstdErr : ...${r.err.slice(-128)}`+`\tstdOut : ...${r.out.slice(-128)}`);return this.onClose(t)}));if(this.onErr){e.stderr.setEncoding("utf8");e.stderr.on("data",this.onErr)}if(this.onOut){e.stdout.setEncoding("utf8");e.stdout.on("data",this.onOut)}if(this.log){this.log.err=this.log.out="";e.stderr.setEncoding("utf8");e.stderr.on("data",(t=>this.log.err+=t));e.stdout.setEncoding("utf8");e.stdout.on("data",(t=>this.log.out+=t))}}kill(){if(this.proc){this.proc.removeAllListeners();this.proc.kill();this.proc=null}}static checkRun(t){try{s(t,{timeout:5e3,stdio:"ignore"})}catch(t){return false}return true}}},138:(t,e,r)=>{const i=r(656);e.Prog={active:false,tick:250,timer:undefined,t_max:0,t_comp:0,t_str:"",c:1,cmax:7,start(t=0){i.saveCur();if(t>0)this.setTask(0,t);this.active=true;this.timer=setInterval(this.upd.bind(this),this.tick)},setTask(t,e){i.restCur().print(" ".repeat(this.t_str.length)).restCur();i.pac(this.t_str=`(${t}/${e}) `)},upd(){i.restCur();if(this.t_str){i.moveR(this.t_str.length,0)}i.clearLine(1).print(".".repeat(this.c));if(++this.c>this.cmax)this.c=1},stop(){if(!this.active)return false;clearInterval(this.timer);i.restCur().clearLine(1);this.active=false;return true}}},656:(t,e,r)=>{const{EOL:i}=r(37);const{stdout:n}=r(282);class Terminal{_ESC_SEQ="[";_BOLD="[1m";_DIM="[2m";_ITAL="[3m";_UNDERL="[4m";_BLINK="[5m";_HIDDEN="[8m";_RESET_ALL="[0m";_RESET_FG="[39m";_RESET_BG="[49m";_RESET_BOLD="[21m";_RESET_DIM="[22m";_RESET_ITAL="[23m";_RESET_UNDERL="[24m";_RESET_BLINK="[25m";_RESET_HIDDEN="[28m";_CURSOR_SAV="[s";_CURSOR_RES="[u";_NL=i;COLORS_FG=new Map([["darkgray","[90m"],["red","[91m"],["green","[92m"],["yellow","[93m"],["blue","[94m"],["magenta","[95m"],["cyan","[96m"],["white","[97m"],["black","[30m"],["darkred","[31m"],["darkgreen","[32m"],["darkyellow","[33m"],["darkblue","[34m"],["darkmagenta","[35m"],["darkcyan","[36m"],["gray","[37m"]]);COLORS_BG=new Map([["darkgray","[100m"],["red","[101m"],["green","[102m"],["yellow","[103m"],["blue","[104m"],["magenta","[105m"],["cyan","[106m"],["white","[107m"],["black","[40m"],["darkred","[41m"],["darkgreen","[42m"],["darkyellow","[43m"],["darkblue","[44m"],["darkmagenta","[45m"],["darkcyan","[46m"],["gray","[47m"]]);setCur(t){return this.print(t?"[?25h":"[?25l")}saveCur(){return this.print(this._CURSOR_SAV)}restCur(){return this.print(this._CURSOR_RES)}up(t=1){return this.print("[${x}A")}down(t=1){return this.print("[${x}B")}forward(t=1){return this.print("[${x}C")}back(t=1){return this.print("[${x}D")}move(t,e){process.stdout.cursorTo(t-1,e-1)}moveR(t,e){process.stdout.moveCursor(t,e)}print(t){n.write(t);return this}println(t){n.write(t+i);return this}clearLine(t=0){n.clearLine(t);return this}fg(t){if(!t)return this.print(this._RESET_FG);return this.print(this.COLORS_FG.get(t))}bg(t){if(!t)return this.print(this._RESET_BG);return this.print(this.COLORS_BG.get(t))}reset(){return this.print(this._RESET_ALL)}endl(){return this.print(i)}n(t=1){return this.print(i.repeat(t))}ptag(t){return this.print(this.parseTags(t))}parseTags(t){const e=/<(\S+?)>/g;t=t.replace(e,((t,e)=>{let r=e.split(",");let n="";for(let e of r){switch(e){case"n":n+=i;break;case"t":n+="\t";break;case"!":n+=this._RESET_ALL;break;case"!fg":n+=this._RESET_ALL;break;case"!bg":n+=this._RESET_ALL;break;case"cs":n+=this._CURSOR_SAV;break;case"cr":n+=this._CURSOR_RES;break;case"bold":n+=this._BOLD;break;case"!bold":n+=this._RESET_BOLD;break;case"underl":n+=this._UNDERL;break;case"!underl":n+=this._RESET_UNDERL;break;case"it":n+=this._ITAL;break;case"!it":n+=this._RESET_ITAL;break;default:if(e.indexOf(":")==0){let r=e.split(":")[1];if(this.COLORS_BG.has(r)){n+=this.COLORS_BG.get(r)}else{throw new Error(`Tag Error: Color Error ${t}`)}}else{if(this.COLORS_FG.get(e)){n+=this.COLORS_FG.get(e)}else{n+=t}}}}return n}));return t}st(t){return t.replace(/<(\S+?)>/g,"")}pac(t){return this.ptag(this.autoColor(t))}autoColor(t){let e=/\b(\d+)|\[(.+?)\]|\{(.+?)\}|'(.+?)'|"(.+?)"|([\-+=:()?<>]+)/g;return t.replace(e,((t,e,r,i,n,s,o)=>{if(e)return`<cyan>${t}<!>`;if(r)return`<green,bold>${t}<!>`;if(i)return`<red,bold>${t}<!>`;if(n)return`<magenta,it>${t}<!>`;if(s)return`<yellow>${t}<!>`;if(o)return`<yellow,bold>${t}<!>`;return"X"}))}}t.exports=new Terminal},857:(t,e,r)=>{const i=r(307);e.copyFields=(t,r)=>{if(t==null)return r;if(r==null)r={};for(let i in t){if(t[i]instanceof Array){Reflect.set(r,i,[...t[i]])}else if(typeof t[i]=="object"){Reflect.set(r,i,e.copyFields(t[i],r[i]))}else{Reflect.set(r,i,t[i])}}return r};e.clamp=(t,e,r)=>Math.min(Math.max(t,e),r);e.randomInt=(t,e)=>Math.round(Math.random()*(e-t))+t;e.randomNum=(t,e)=>t+(t-e)*Math.random();e.bytesToMBStr=t=>""+Math.ceil(t/(1024*1024));e.roundFloat=(t,e=2)=>{t*=Math.pow(10,e);return Math.round(t)/Math.pow(10,e)};Object.defineProperty(Array.prototype,"last",{value:function(t=1){if(this==null){throw new TypeError("this is null or not defined")}if(this.length==0)return undefined;if(this.length-t<0)return this[0];return this[this.length-t]},writable:false,enumerable:false,configurable:false});Object.defineProperty(Array.prototype,"queueRun",{value:function(t){const e=this;const q=()=>{let r=e.shift();t.call(e,r,(()=>{process.nextTick(q)}))};q()},writable:true,enumerable:false,configurable:true});e.PromiseRun=(t,e=4,r)=>new Promise(((n,s)=>{let o=0;let a=0;let l=null;function tryAdd(){if(l){if(o==0){i.error(`PromiseRun -- END WITH ERRORS (${l.length}) -- Run (${a})`);return s(l)}return}let e=t.next();if(e.done){if(o==0){i.log(`PromiseRun -- END -- ALL (${a}) SETTLED`);return n()}return}o++;e.value.catch((t=>{if(!l)l=[];if(t instanceof Error){l.push(t.message)}else{l.push(t)}})).finally((()=>{a++;o--;i.debug(`PromiseRun -- Completed (${a}) `);if(typeof r=="function")r(a);tryAdd()}))}i.log(`PromiseRun -- START -- Max parallel (${e})`);while(e--)tryAdd()}))},81:t=>{"use strict";t.exports=require("child_process")},147:t=>{"use strict";t.exports=require("fs")},37:t=>{"use strict";t.exports=require("os")},17:t=>{"use strict";t.exports=require("path")},282:t=>{"use strict";t.exports=require("process")}};var e={};function __nccwpck_require__(r){var i=e[r];if(i!==undefined){return i.exports}var n=e[r]={exports:{}};var s=true;try{t[r](n,n.exports,__nccwpck_require__);s=false}finally{if(s)delete e[r]}return n.exports}if(typeof __nccwpck_require__!=="undefined")__nccwpck_require__.ab=__dirname+"/";var r={};(()=>{const t=__nccwpck_require__(147);const e=__nccwpck_require__(17);const{cpus:r}=__nccwpck_require__(37);const i=__nccwpck_require__(513);const n=__nccwpck_require__(656);const s=__nccwpck_require__(138);const o=__nccwpck_require__(307);const a=__nccwpck_require__(857);const l=__nccwpck_require__(216);const c=__nccwpck_require__(355);const u=__nccwpck_require__(84);const p=Math.ceil(r().length*.75);const h={rawStr:"-f|s16le|-ar|44100|-ac|2",enc:{MP3:{name:"Mp3",ext:".mp3",pf:"k Cbr",min:32,max:320,get(t){return`-c:a|libmp3lame|-b:a|${t}k`}},MP3V:{name:"Mp3",ext:".mp3",pf:"k Vbr",min:44,max:256,get(t){return"-c:a|libmp3lame|-q:a|"+a.clamp(9-Math.round(9*(t-44)/212),0,9)}},VORBIS:{name:"Vorbis",ext:".ogg",pf:"k Vbr",min:64,max:500,get(t){let e=[64,80,96,112,128,160,192,224,256,320,500],r=0;while(t>e[r++]);if(r>10)r=10;let i=e[r-1];let n=(t-i)/(e[r]-i);return"-c:a|libvorbis|-q|"+a.roundFloat(r-1+n,2)}},OPUS:{name:"Opus",ext:".opus",pf:"k Vbr",min:28,max:500,get(t){return`-c:a|libopus|-vbr|on|-compression_level|10|-b:a|${t}k`}},FLAC:{name:"Flac Lossless",ext:".flac",get(){return"-c:a|flac"}}},getEnc:function(t){if(!t)return null;let e=t.toUpperCase().split(":");let r=this.enc[e[0]];if(!r)return null;let i={ext:r.ext,desc:r.name,str:null};let n=parseInt(e[1]);if(Number.isNaN(n)){if(r.max)return null}if(r.max){n=a.clamp(n,r.min,r.max);i.desc+=` ${n}${r.pf}`}i.str=r.get(n);return i}};function createOuputDir(r,i){let n=i??r.FILE_DIR;n=e.resolve(e.normalize(n));n=e.join(n,r.CD_TITLE);n+=" [e]";while(t.existsSync(n)){let t=/\((\d+)\)$/.exec(n);if(!t){n+=" (2)"}else{n=n.slice(0,t.index);n+="("+(parseInt(t[1])+1)+")"}}o.log(`Creating CD output dir "${n}"`);try{t.mkdirSync(n,{recursive:true})}catch(t){o.error(" .. FAILED");throw`Cannot create : "${n}"`}return n}function printEStats(t){let e=d.inputs.length;if(e<2)return;n.pac(` >> 'Input' (${e}) Cue Files\n`);n.pac(` >> [Encoded] (${d.success}/${e}) \n`);let func=(t,r)=>{if(t.size){n.pac(` >> ${r[0]} (${t.size}/${e}) ${r[1]}`);let i=0;t.forEach(((t,e)=>{n.pac(`\t${++i}.'${d.inputs[e]}' -- {${t}}\n`)}))}};func(d.skip,["{Skipped}","\n"]);func(d.error,["{Failed}","\n"]);n.n();if(t){n.ptag("<:darkmagenta,white> >> USER ABORTED  <!,n>")}}function taskEncodeCD(r){return new Promise(((g,m)=>{let _=Date.now();let E=new u;E.loadCue(r);if(E.tracks.every((t=>t.isData)))throw"+CD has no Audio Tracks";let y=0;let S=i.output;if(S=="=src")S=null;let k=createOuputDir(E,S);let w=E.CD_TITLE+" - Track ";let b="  - ";n.pac(`${b}Output : "${k}"\n`);n.pac(`${b}Audio Enc : '${f.desc}'\n`);n.pac(`${b}Converting Tracks `);s.Prog.start(E.tracks.length);const gen=function*(){for(let r=0;r<E.tracks.length;r++){let i=E.tracks[r];let n=e.join(k,w+i.noStr);if(i.isData){y+=i.byteSize;yield l.copyPart(E.getTrackFilePath(r),`${n}.bin`,i.byteStart,i.byteSize)}else{let e=t.createReadStream(E.getTrackFilePath(r),{start:i.byteStart,end:i.byteStart+i.byteSize-1,flags:"r"});let s=new c("ffmpeg");let o=s.startP(`-y|${h.rawStr}|-i|pipe:0|${f.str}|${n+f.ext}`);s.proc.prependListener("close",(t=>{let e=s.logExit.err.slice(-120);let r=/audio:(\d+)kB/.exec(e);if(r)y+=parseInt(r[1])*1024}));e.pipe(s.stdin);yield o}}return 0};a.PromiseRun(gen(),i.option.p??p,(t=>{s.Prog.setTask(t,E.tracks.length)})).then((()=>{s.Prog.stop();byteStr=`${a.bytesToMBStr(E.CD_SIZE)}MB -> ${a.bytesToMBStr(y)}MB`;n.pac(`[OK]\n`);n.pac(b+`CD Size : `+byteStr);n.ptag("<darkgray,it> | time "+new Date(Date.now()-_+500).toISOString().slice(14,19).replace(":","m:")+"s<!,n>");let r=["REM "+"-".repeat(50)];r.push("REM | "+E.CD_TITLE);r.push(r[0]);r.push(`REM | Converted with CBAE v${i.IP.ver} - Cue/Bin Audio Encoder`);r.push(`REM | CD Size : ${byteStr}`);r.push("REM | Audio Quality : "+f.desc);r.push(r[0],"");r=r.concat(E.generateCueForEncoded(w,f.ext));let l=E.CD_TITLE+".cue";try{o.log("> All tracks Complete. Writing CUE file");t.writeFileSync(e.join(k,l),r.join("\n"))}catch(t){throw[`Failed to write : '${l}'`]}d.success++;d.size0+=E.CD_SIZE;d.size1+=y})).catch((e=>{if(s.Prog.stop()){n.n()}t.renameSync(k,`${k} (${Date.now()}) (failed)`);e=e[0];if(typeof e=="string"){m(e)}else{m("FFmpeg general error. Not enough disk space?")}})).then(g)}))}i.init({name:"CBAE",ver:"0.9",desc:"Cue/Bin Audio Encoder",actions:{e:"!Encode cue/bin to output folder. Will create the new<|>track files and the new .cue file under a subfolder",i:"Display cue/bin information "},options:{enc:["Audio Codec String <yellow>ID:KBPS<!> <|>"+"List of supported Encoders:<|>"+"<yellow>MP3<!>:(32-320) Constant Bitrate | <yellow>MP3V<!>:(44-256) Variable Bitrate <|>"+"<yellow>VORBIS<!>:(64-500) | <yellow>OPUS<!>:(28-500) | <yellow>FLAC<!> | <darkgray,it> e.g. -enc OPUS:64<!>",1],p:["Set max parallel operations.",1,p]},help:{ehelp:true,info:"<darkgray>  Author : John32B | https://github.com/john32b/cbae <!,n>"+"  Encodes the Audio Tracks of a cue/bin CD image and builds a new .cue file",usage:"<t,magenta>input:<!> .cue files only. Supports multiple files.<n,t,magenta>output:<!> A new folder will be created for each cue/bin in this folder.<n,t,t>You can use <yellow>=src<!> for source folder"},require:{input:"yes",output:"e,d"}});var f;var d={inputs:null,success:0,error:new Map,skip:new Map,size0:0,size1:0};n.setCur(false);i.printBanner();if(i.input.length==0){n.pac(" > No input files \n");process.exit(0)}if(i.action=="i"){o.log("> Action: Information ::");let t=i.input.length;let e=0;i.input.queueRun(((r,i)=>{if(r==undefined){process.exit(0)}let s=t>1?`(${++e}/${t}) `:"";n.pac(`\n==> Input ${s} : "${r}"\n`);let l=new u;try{l.loadCue(r)}catch(t){o.error(t);n.pac(`  > {ERROR} : ${t}\n`);return i()}let c=a.bytesToMBStr;let p=l.getAudioSize();n.pac(`  > CD Title:'${l.CD_TITLE}' | Size:${c(l.CD_SIZE)}MB (Data:${c(l.CD_SIZE-p)}MB Audio:${c(p)}MB) | Tracks ${l.tracks.length}\n`);for(let t of l.tracks){n.pac(`\t> Track${t.noStr} | Type:${t.type} | Size:${c(t.byteSize)}MB\n`)}i()}))}if(i.action=="e"){o.log("> Action: Encode ::");d.inputs=[...i.input];let t=i.input.length;let e=0;let printLine=()=>n.ptag("  <darkgray>"+"-".repeat(40)+"<!,n>");try{if(!c.checkRun("ffmpeg -version"))throw"Cannot run ffmpeg. Is it set on path?";if(!i.option.enc)throw"You need to set an encoder with '-enc'";f=h.getEnc(i.option.enc);if(!f)throw"Encoding String Error. Run with '-enc help' for encoding info"}catch(t){i.exitError(n.autoColor(t))}process.prependOnceListener("exit",(t=>{s.Prog.stop();if(t==1223){n.ptag("<:darkmagenta,white> USER ABORT <!,n>");printLine()}printEStats(t==1223)}));i.input.queueRun(((r,i)=>{if(r==undefined){process.exit(0)}let s=t>1?`(${e+1}/${t}) `:"";n.pac(`==> Input ${s} : "${r}"\n`);taskEncodeCD(r).catch((t=>{let r;if(t.charAt(0)=="+"){t=t.slice(1);d.skip.set(e,t);r="{warning}"}else{d.error.set(e,t);r="{ERROR}"}o.error(t);n.pac(`\t${r} : ${t}`).ptag(" | <cyan,it>skipping<!,n>")})).then((()=>{e++;printLine();i()}))}))}})();module.exports=r})();